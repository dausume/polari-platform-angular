<div class="dynamic-data-table">
  <!-- Header -->
  <div class="table-header">
    <div class="header-left">
      <h3 class="table-title">{{ classDisplayName || className }}</h3>
      <span class="record-count" *ngIf="dataSource.data.length > 0">
        {{ dataSource.filteredData.length }} of {{ dataSource.data.length }} records
      </span>
    </div>

    <div class="header-actions">
      <!-- Search -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Filter data..." #searchInput>
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Refresh button -->
      <button mat-icon-button (click)="refreshData()" matTooltip="Refresh data" [disabled]="isLoading">
        <mat-icon [class.spin]="isLoading">refresh</mat-icon>
      </button>

      <!-- Create button - only shown if config allows AND class permissions allow -->
      <button *ngIf="mergedConfig.enableCreate && canCreate"
              mat-raised-button
              color="primary"
              (click)="openCreateDialog()"
              class="create-btn">
        <mat-icon>add</mat-icon>
        Add New
      </button>
    </div>
  </div>

  <!-- Error Banner -->
  <div *ngIf="error" class="error-banner">
    <mat-icon>error</mat-icon>
    <span>{{ error }}</span>
    <button mat-icon-button (click)="error = null">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-overlay">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading data...</span>
  </div>

  <!-- Table Container -->
  <div class="table-container" [class.loading]="isLoading">
    <table mat-table [dataSource]="dataSource" matSort class="data-table">

      <!-- Data Columns -->
      <ng-container *ngFor="let column of displayedColumns">
        <!-- Skip actions column - handled separately -->
        <ng-container *ngIf="column !== '_actions'" [matColumnDef]="column">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ getColumnDisplayName(column) }}
          </th>
          <td mat-cell *matCellDef="let row">
            <!-- Read mode (not editing this row) -->
            <ng-container *ngIf="!isRowEditing(row)">
              <!-- String cell -->
              <editable-string-cell *ngIf="getCellType(column) === 'string'"
                                    mode="read"
                                    [value]="row[column]"
                                    [fieldName]="column"
                                    (editStarted)="onRowEdit({ action: 'edit', rowData: row })"
                                    (valueChange)="onCellValueChange(row, column, $event)">
              </editable-string-cell>

              <!-- Number cell -->
              <editable-number-cell *ngIf="getCellType(column) === 'number'"
                                    mode="read"
                                    [value]="row[column]"
                                    [fieldName]="column"
                                    [isInteger]="getVarDef(column)?.varType === 'int'"
                                    (editStarted)="onRowEdit({ action: 'edit', rowData: row })"
                                    (valueChange)="onCellValueChange(row, column, $event)">
              </editable-number-cell>

              <!-- Boolean cell -->
              <editable-boolean-cell *ngIf="getCellType(column) === 'boolean'"
                                     mode="read"
                                     [value]="row[column]"
                                     [fieldName]="column"
                                     (editStarted)="onRowEdit({ action: 'edit', rowData: row })"
                                     (valueChange)="onCellValueChange(row, column, $event)">
              </editable-boolean-cell>

              <!-- Date cell -->
              <editable-date-cell *ngIf="getCellType(column) === 'date'"
                                  mode="read"
                                  [value]="row[column]"
                                  [fieldName]="column"
                                  [includeTime]="getVarDef(column)?.varType === 'datetime'"
                                  (editStarted)="onRowEdit({ action: 'edit', rowData: row })"
                                  (valueChange)="onCellValueChange(row, column, $event)">
              </editable-date-cell>

              <!-- Select cell -->
              <editable-select-cell *ngIf="getCellType(column) === 'select'"
                                    mode="read"
                                    [value]="row[column]"
                                    [fieldName]="column"
                                    [options]="getVarDef(column)?.options || []"
                                    (editStarted)="onRowEdit({ action: 'edit', rowData: row })"
                                    (valueChange)="onCellValueChange(row, column, $event)">
              </editable-select-cell>
            </ng-container>

            <!-- Edit mode -->
            <ng-container *ngIf="isRowEditing(row)">
              <!-- String cell -->
              <editable-string-cell *ngIf="getCellType(column) === 'string'"
                                    mode="edit"
                                    [value]="row[column]"
                                    [fieldName]="column"
                                    [required]="getVarDef(column)?.required || false"
                                    (valueChange)="onCellValueChange(row, column, $event)">
              </editable-string-cell>

              <!-- Number cell -->
              <editable-number-cell *ngIf="getCellType(column) === 'number'"
                                    mode="edit"
                                    [value]="row[column]"
                                    [fieldName]="column"
                                    [isInteger]="getVarDef(column)?.varType === 'int'"
                                    [required]="getVarDef(column)?.required || false"
                                    (valueChange)="onCellValueChange(row, column, $event)">
              </editable-number-cell>

              <!-- Boolean cell -->
              <editable-boolean-cell *ngIf="getCellType(column) === 'boolean'"
                                     mode="edit"
                                     [value]="row[column]"
                                     [fieldName]="column"
                                     (valueChange)="onCellValueChange(row, column, $event)">
              </editable-boolean-cell>

              <!-- Date cell -->
              <editable-date-cell *ngIf="getCellType(column) === 'date'"
                                  mode="edit"
                                  [value]="row[column]"
                                  [fieldName]="column"
                                  [includeTime]="getVarDef(column)?.varType === 'datetime'"
                                  [required]="getVarDef(column)?.required || false"
                                  (valueChange)="onCellValueChange(row, column, $event)">
              </editable-date-cell>

              <!-- Select cell -->
              <editable-select-cell *ngIf="getCellType(column) === 'select'"
                                    mode="edit"
                                    [value]="row[column]"
                                    [fieldName]="column"
                                    [options]="getVarDef(column)?.options || []"
                                    [required]="getVarDef(column)?.required || false"
                                    (valueChange)="onCellValueChange(row, column, $event)">
              </editable-select-cell>
            </ng-container>
          </td>
        </ng-container>
      </ng-container>

      <!-- Actions Column - uses effectiveRowActionsConfig which respects class permissions -->
      <ng-container matColumnDef="_actions">
        <th mat-header-cell *matHeaderCellDef class="actions-header">Actions</th>
        <td mat-cell *matCellDef="let row" class="actions-cell">
          <row-actions-cell
            [config]="effectiveRowActionsConfig"
            [rowData]="row"
            [rowId]="row.id || row._instanceId"
            [isEditing]="isRowEditing(row)"
            [isDirty]="getRowState(row)?.isDirty || false"
            [isValid]="getRowState(row)?.isValid !== false"
            [isSaving]="getRowState(row)?.isSaving || false"
            [compact]="true"
            (edit)="onRowEdit($event)"
            (delete)="onRowDelete($event)"
            (save)="onRowSave($event)"
            (cancel)="onRowCancel($event)">
          </row-actions-cell>
        </td>
      </ng-container>

      <!-- Header and Row definitions -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          [class.editing]="isRowEditing(row)"
          [class.dirty]="getRowState(row)?.isDirty"></tr>

      <!-- No data row -->
      <tr class="mat-row no-data-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="no-data-message">
            <mat-icon>inbox</mat-icon>
            <span *ngIf="dataSource.filter">No matching records found</span>
            <span *ngIf="!dataSource.filter">No data available</span>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- Paginator -->
  <mat-paginator
    [length]="dataSource.data.length"
    [pageSize]="mergedConfig.pageSize || 10"
    [pageSizeOptions]="mergedConfig.pageSizeOptions || [5, 10, 25, 50]"
    showFirstLastButtons>
  </mat-paginator>
</div>
