<mat-card class="no-code-container" (contextmenu)="showContextMenu($event)">
    <div class="main-content-area">
      <div class="canvas-wrapper">
      <div class="canvas-toolbar">
        <div class="toolbar-left">
          <span class="toolbar-title">{{ noCodeSolution?.solutionName || 'No-Code Solution' }}</span>
        </div>
        <div class="solution-selector">
          <label for="solution-select">Solution:</label>
          <select
            id="solution-select"
            (change)="onSolutionChange($any($event.target).value)">
            <option
              *ngFor="let solution of availableSolutions"
              [value]="solution.name"
              [selected]="solution.name === selectedSolutionName">
              {{ solution.name }}
            </option>
          </select>
          <button class="reset-btn" (click)="resetToDefaults()" title="Reset to default solutions">Reset Data</button>
        </div>
        <div class="zoom-controls">
          <button (click)="zoomOut()" title="Zoom Out">-</button>
          <span class="zoom-level">{{ zoomPercent }}%</span>
          <button (click)="zoomIn()" title="Zoom In">+</button>
          <button (click)="resetZoom()" title="Reset View">Reset</button>
        </div>

        <!-- Solution Options Menu -->
        <div class="solution-options">
          <button class="options-btn"
                  [matMenuTriggerFor]="solutionOptionsMenu"
                  title="Solution Options">
            <mat-icon>settings</mat-icon>
          </button>
          <mat-menu #solutionOptionsMenu="matMenu" class="solution-options-menu">
            <button mat-menu-item (click)="toggleRenderingDebug()">
              <mat-icon>{{ showRenderingDebug ? 'visibility' : 'visibility_off' }}</mat-icon>
              <span>{{ showRenderingDebug ? 'Hide' : 'Show' }} Rendering Debug</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="toggleSlotLabels()">
              <mat-icon>{{ showSlotLabels ? 'label' : 'label_off' }}</mat-icon>
              <span>{{ showSlotLabels ? 'Hide' : 'Show' }} Slot Labels</span>
            </button>
            <button mat-menu-item (click)="toggleConnectorLabels()">
              <mat-icon>{{ showConnectorLabels ? 'linear_scale' : 'remove' }}</mat-icon>
              <span>{{ showConnectorLabels ? 'Hide' : 'Show' }} Connector Labels</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="exportSolution()">
              <mat-icon>download</mat-icon>
              <span>Export Solution</span>
            </button>
          </mat-menu>
        </div>
      </div>
      <div id="d3-graph"></div>
      <div class="canvas-info">
        Pan: Click & Drag | Zoom: Scroll or Buttons
      </div>
    </div>

      <!-- State Tool Sidebar (Right Side) -->
      <app-state-tool-sidebar
        [isExpanded]="sidebarExpanded"
        [boundClass]="boundClass"
        [availableHelperClasses]="availableHelperClasses"
        [enabledHelperClasses]="enabledHelperClasses"
        [availableSubSolutions]="availableSubSolutions"
        [generatedPythonCode]="generatedPythonCode"
        [solutionName]="noCodeSolution?.solutionName || ''"
        [existingUniqueStates]="existingUniqueStates"
        (createStateFromDefinition)="onCreateStateFromDefinition($event)"
        (createStateFromClassMember)="onCreateStateFromClassMember($event)"
        (toggleHelperClass)="onToggleHelperClass($event)"
        (createStateFromSubSolution)="onCreateSubSolutionState($event)"
        (openDefinitionCreator)="onOpenDefinitionCreator()"
        (toggleExpanded)="onSidebarToggle($event)">
      </app-state-tool-sidebar>
    </div>

    <!-- State Definition Creator Panel (slides in from right) -->
    <div class="definition-creator-panel" [class.open]="showDefinitionCreator">
      <div class="panel-header">
        <h3>State Definition Creator</h3>
        <button mat-icon-button (click)="closeDefinitionCreator()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="panel-content">
        <app-state-definition-creator
          *ngIf="showDefinitionCreator"
          [existingDefinition]="editingDefinition"
          [availableSolutionsInput]="availableSolutions"
          (definitionSaved)="onDefinitionSaved($event)"
          (cancelled)="closeDefinitionCreator()">
        </app-state-definition-creator>
      </div>
    </div>

    <!-- Backdrop for panel -->
    <div class="panel-backdrop" *ngIf="showDefinitionCreator" (click)="closeDefinitionCreator()"></div>

    <!-- State Context Menu -->
    <app-state-context-menu
      *ngIf="stateContextMenuVisible"
      [stateName]="contextMenuStateName"
      [currentShapeType]="contextMenuShapeType"
      [currentSize]="contextMenuCurrentSize"
      [position]="contextMenuPosition"
      (menuAction)="onContextMenuAction($event)"
      (menuClosed)="closeContextMenu()">
    </app-state-context-menu>

    <!-- Slot Manager Popup -->
    <state-slot-manager-popup
      *ngIf="slotManagerVisible"
      [stateName]="slotManagerStateName"
      [inputSlots]="slotManagerInputSlots"
      [outputSlots]="slotManagerOutputSlots"
      [solutionDefaults]="solutionSlotDefaults"
      [position]="slotManagerPosition"
      (slotsChanged)="onSlotManagerChanged($event)"
      (slotConfigRequested)="onSlotConfigRequested($event)"
      (closed)="closeSlotManager()">
    </state-slot-manager-popup>

    <!-- Slot Configuration Popup -->
    <slot-configuration-popup
      *ngIf="slotConfigPopupVisible && currentSlotConfig"
      [configuration]="currentSlotConfig"
      [position]="slotConfigPosition"
      [stateContext]="slotConfigStateContext"
      [stateClass]="slotConfigStateClass"
      [producedVariables]="slotConfigProducedVariables"
      (configurationChanged)="onSlotConfigChanged($event)"
      (closed)="closeSlotConfigPopup()">
    </slot-configuration-popup>

    <!-- Backdrop for slot manager -->
    <div class="popup-backdrop" *ngIf="slotManagerVisible" (click)="closeSlotManager()"></div>

    <!-- Full View Popup -->
    <state-full-view-popup
      *ngIf="fullViewPopupVisible && fullViewPopupState"
      [position]="fullViewPopupPosition"
      [stateName]="getFullViewStateName()"
      [stateType]="getFullViewStateType()"
      [boundClassName]="fullViewPopupState.boundObjectClass || ''"
      [functionName]="getFullViewFunctionName()"
      [variableName]="getFullViewVariableName()"
      [solutionName]="getFullViewSolutionName()"
      [inputSlotCount]="getFullViewInputSlotCount()"
      [outputSlotCount]="getFullViewOutputSlotCount()"
      [isEditable]="true"
      (classSelected)="onFullViewClassSelected($event)"
      (fieldChanged)="onFullViewFieldChanged($event)"
      (closed)="closeFullViewPopup()">
    </state-full-view-popup>

    <!-- Backdrop for full view popup -->
    <div class="popup-backdrop" *ngIf="fullViewPopupVisible" (click)="closeFullViewPopup()"></div>

    <!-- View Context Overlay (Debug) -->
    <view-context-overlay
      *ngIf="viewContextOverlayVisible"
      [context]="viewContextOverlayContext"
      [stateName]="viewContextOverlayStateName"
      [solutionName]="selectedSolutionName || ''"
      [position]="viewContextOverlayPosition"
      (closed)="closeViewContextOverlay()">
    </view-context-overlay>
</mat-card>
