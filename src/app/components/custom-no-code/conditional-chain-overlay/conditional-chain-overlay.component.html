<div class="conditional-chain-overlay"
     [class.compact]="isCompact"
     [class.small]="isSmall"
     (click)="onOverlayClick($event)"
     (mousedown)="onMouseDown($event)"
     (pointerdown)="onMouseDown($event)">

  <!-- Header with mode tabs -->
  <div class="overlay-header">
    <span class="title">Conditional Chain</span>
    <div class="mode-tabs" *ngIf="!isCompact">
      <button class="tab-btn"
              [class.active]="editorMode === 'visual'"
              (click)="setEditorMode('visual')">
        <mat-icon>view_list</mat-icon>
        <span *ngIf="!isSmall">Visual</span>
      </button>
      <button class="tab-btn"
              [class.active]="editorMode === 'syntax'"
              (click)="setEditorMode('syntax')">
        <mat-icon>code</mat-icon>
        <span *ngIf="!isSmall">Syntax</span>
      </button>
    </div>
  </div>

  <!-- Slot info bar -->
  <div class="slot-info-bar" *ngIf="!isCompact">
    <div class="slot-info">
      <mat-icon class="slot-icon input">input</mat-icon>
      <span class="slot-count">{{ inputSlotCount }} input(s)</span>
    </div>
    <button class="add-input-btn"
            *ngIf="canAddInput()"
            (click)="requestAddInputSlot()"
            title="Add input slot">
      <mat-icon>add_circle</mat-icon>
      <span *ngIf="!isSmall">Add Input</span>
    </button>
    <div class="slot-info output">
      <mat-icon class="slot-icon">output</mat-icon>
      <span class="slot-type">boolean</span>
    </div>
  </div>

  <!-- Visual Mode: Compact row-based chain builder -->
  <div class="visual-editor" *ngIf="editorMode === 'visual' && !isCompact">
    <div class="conditions-list">
      <div class="condition-link" *ngFor="let link of visualLinks; let i = index; let first = first">
        <!-- Logical operator (except for first) -->
        <div class="logical-operator" *ngIf="!first">
          <select [(ngModel)]="visualLinks[i-1].logicalOperator"
                  (change)="onFieldChange(i-1, 'logicalOperator', getEventTargetValue($event))"
                  class="operator-select">
            <option *ngFor="let op of logicalOperators" [value]="op.value">{{ op.label }}</option>
          </select>
        </div>

        <!-- Compact condition row: [Left] [Op] [Right] [X] -->
        <div class="condition-row compact-row">
          <!-- Left value button -->
          <button class="value-display-btn left-btn"
                  [class.active]="popupVisible && popupLinkIndex === i && popupEditingSide === 'left'"
                  (click)="openValuePopup($event, i, 'left')"
                  title="Click to edit left value">
            <span class="value-text">{{ getCompactDisplayText(link.leftSource) }}</span>
            <mat-icon class="edit-icon">edit</mat-icon>
          </button>

          <!-- Condition type dropdown -->
          <select [(ngModel)]="link.conditionType"
                  (change)="onFieldChange(i, 'conditionType', getEventTargetValue($event))"
                  class="condition-select">
            <option *ngFor="let ct of conditionTypes" [value]="ct.value">{{ ct.displayName }}</option>
          </select>

          <!-- Right value button (if needed) -->
          <button class="value-display-btn right-btn"
                  *ngIf="!requiresNoValue(link.conditionType)"
                  [class.active]="popupVisible && popupLinkIndex === i && popupEditingSide === 'right'"
                  (click)="openValuePopup($event, i, 'right')"
                  title="Click to edit right value">
            <span class="value-text">{{ getCompactDisplayText(link.rightSource) }}</span>
            <mat-icon class="edit-icon">edit</mat-icon>
          </button>

          <!-- End value button for BETWEEN -->
          <button class="value-display-btn end-btn"
                  *ngIf="requiresSecondValue(link.conditionType)"
                  [class.active]="popupVisible && popupLinkIndex === i && popupEditingSide === 'rightEnd'"
                  (click)="openValuePopup($event, i, 'rightEnd')"
                  title="Click to edit end value">
            <span class="value-text">{{ getCompactDisplayText(link.rightSourceEnd) }}</span>
            <mat-icon class="edit-icon">edit</mat-icon>
          </button>

          <!-- Remove button -->
          <button class="remove-btn" (click)="removeConditionLink(i)" title="Remove condition">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <!-- Empty state -->
      <div class="empty-state" *ngIf="visualLinks.length === 0">
        <span>No conditions defined</span>
      </div>
    </div>

    <!-- Add condition button -->
    <button class="add-condition-btn" (click)="addConditionLink()">
      <mat-icon>add</mat-icon>
      <span>Add Condition</span>
    </button>
  </div>

  <!-- Value Source Popup (position: fixed, renders above everything) -->
  <div class="value-popup"
       *ngIf="popupVisible"
       [style.top.px]="popupPosition.top"
       [style.left.px]="popupPosition.left"
       (click)="$event.stopPropagation()"
       (mousedown)="$event.stopPropagation()"
       (pointerdown)="$event.stopPropagation()">
    <div class="popup-header">
      <span class="popup-title">{{ getPopupLabel() }}</span>
      <button class="popup-close-btn" (click)="closeValuePopup()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="popup-content">
      <app-value-source-selector
        [config]="getPopupConfig()"
        [availableInputs]="getAvailableInputsForSelector()"
        [sourceObjectFields]="sourceObjectFields"
        [label]="''"
        [compact]="false"
        (configChange)="onPopupConfigChange($event)">
      </app-value-source-selector>
    </div>
  </div>

  <!-- Syntax Mode: Text-based condition editor -->
  <div class="syntax-editor" *ngIf="editorMode === 'syntax' && !isCompact">
    <textarea
      [formControl]="syntaxControl"
      (input)="onSyntaxChange()"
      class="syntax-input"
      [class.invalid]="!syntaxValid"
      placeholder="e.g., status == 'active' AND count > 10"></textarea>

    <div class="syntax-help">
      <span class="help-text">Use: field == value, AND, OR, >, <, >=, <=, CONTAINS, IS NULL</span>
    </div>

    <div class="syntax-error" *ngIf="!syntaxValid && syntaxError">
      <mat-icon>error</mat-icon>
      <span>{{ syntaxError }}</span>
    </div>

    <div class="syntax-preview" *ngIf="syntaxValid && visualLinks.length > 0">
      <span class="preview-label">Parsed:</span>
      <span class="preview-count">{{ visualLinks.length }} condition(s)</span>
    </div>
  </div>

  <!-- Compact mode: just show summary -->
  <div class="compact-summary" *ngIf="isCompact">
    <mat-icon>filter_alt</mat-icon>
    <span>{{ visualLinks.length }} conditions</span>
  </div>
</div>
