<div class="data-table-container">
    <!-- Header Section -->
    <div class="table-header-section">
        <div class="table-title">
            <h3>{{className}} Data Table</h3>
            <span class="record-count">{{dataSource.data.length}} records</span>
        </div>

        <div class="header-actions">
            <!-- Filter Input -->
            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Filter</mat-label>
                <input matInput (keyup)="applyFilter($event)" placeholder="Search..." #input class="filter-input">
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <!-- Table Options Button -->
            <button mat-icon-button [matMenuTriggerFor]="tableOptionsMenu" title="Table options" class="options-btn">
                <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #tableOptionsMenu="matMenu" class="table-options-menu">
                <div class="menu-section-label" (click)="$event.stopPropagation()">Column Visibility</div>
                <button mat-menu-item *ngFor="let col of availableColumns" (click)="$event.stopPropagation(); toggleColumn(col)">
                    <mat-icon>{{ isColumnVisible(col) ? 'visibility' : 'visibility_off' }}</mat-icon>
                    <span>{{ getColumnDisplayName(col) }}</span>
                </button>
            </mat-menu>

            <!-- Create New Button - only shown if class allows instance creation -->
            <button *ngIf="canCreate" mat-raised-button color="primary" (click)="openCreateDialog()" class="create-btn">
                <mat-icon>add</mat-icon>
                Create New
            </button>
        </div>
    </div>

    <!-- Column Selector -->
    <div class="column-selector" *ngIf="availableColumns.length > 0 && !hideColumnSelector">
        <span class="selector-label">Columns ({{availableColumns.length}}):</span>
        <div class="column-chips">
            <span
                *ngFor="let col of availableColumns"
                class="chip-wrapper"
                (click)="toggleColumn(col)"
                [class.visibility-visible]="isColumnVisible(col)"
                [class.visibility-hidden]="!isColumnVisible(col)">
                <span class="chip-icon">{{getTypeIcon(getColumnType(col))}}</span>
                {{getColumnDisplayName(col)}}
            </span>
        </div>
    </div>

    <!-- Standard Table Mode -->
    <div class="table-wrapper" *ngIf="!wrappedMode">
        <table mat-table [dataSource]="dataSource" matSort class="data-table">
            <!-- Dynamic Columns -->
            <ng-container *ngFor="let column of dataColumns" [matColumnDef]="column">
                <th mat-header-cell *matHeaderCellDef mat-sort-header [attr.data-type]="getColumnType(column)">
                    <div class="header-content">
                        <span class="header-icon">{{getTypeIcon(getColumnType(column))}}</span>
                        <span class="header-text">{{getColumnDisplayName(column)}}</span>
                        <span class="header-type">({{getColumnType(column)}})</span>
                    </div>
                </th>
                <td mat-cell *matCellDef="let row" [attr.data-type]="getColumnType(column)">
                    <ng-container [ngSwitch]="getColumnType(column).toLowerCase()">
                        <string-cell *ngSwitchCase="'str'" [value]="row[column]" [columnName]="column"></string-cell>
                        <string-cell *ngSwitchCase="'string'" [value]="row[column]" [columnName]="column"></string-cell>
                        <number-cell *ngSwitchCase="'int'" [value]="row[column]" [columnName]="column" [type]="'int'"></number-cell>
                        <number-cell *ngSwitchCase="'integer'" [value]="row[column]" [columnName]="column" [type]="'int'"></number-cell>
                        <number-cell *ngSwitchCase="'float'" [value]="row[column]" [columnName]="column" [type]="'float'"></number-cell>
                        <boolean-cell *ngSwitchCase="'bool'" [value]="row[column]" [columnName]="column"></boolean-cell>
                        <boolean-cell *ngSwitchCase="'boolean'" [value]="row[column]" [columnName]="column"></boolean-cell>
                        <date-cell *ngSwitchCase="'date'" [value]="row[column]" [columnName]="column" [type]="'date'"></date-cell>
                        <date-cell *ngSwitchCase="'datetime'" [value]="row[column]" [columnName]="column" [type]="'datetime'"></date-cell>
                        <list-cell *ngSwitchCase="'list'" [value]="row[column]" [columnName]="column"></list-cell>
                        <list-cell *ngSwitchCase="'polarilist'" [value]="row[column]" [columnName]="column"></list-cell>
                        <dict-cell *ngSwitchCase="'dict'" [value]="row[column]" [columnName]="column"></dict-cell>
                        <dict-cell *ngSwitchCase="'polaridict'" [value]="row[column]" [columnName]="column"></dict-cell>
                        <object-cell *ngSwitchCase="'object'" [value]="row[column]" [columnName]="column"></object-cell>
                        <span *ngSwitchDefault>{{formatCellValue(row[column], getColumnType(column))}}</span>
                    </ng-container>
                </td>
            </ng-container>

            <!-- Actions Column - only shown if edit or delete is allowed -->
            <ng-container matColumnDef="_actions">
                <th mat-header-cell *matHeaderCellDef class="actions-header">Actions</th>
                <td mat-cell *matCellDef="let row" class="actions-cell">
                    <div class="row-actions">
                        <button *ngIf="canEdit" mat-icon-button color="primary" (click)="openEditDialog(row)" matTooltip="Edit">
                            <mat-icon>edit</mat-icon>
                        </button>
                        <button *ngIf="canDelete" mat-icon-button color="warn" (click)="confirmDelete(row)" matTooltip="Delete">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                </td>
            </ng-container>

            <!-- Header and Row Declarations -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                class="table-row"
                [class.selected]="false">
            </tr>

            <!-- No Data Row -->
            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
                    <div class="no-data-message">
                        <mat-icon>inbox</mat-icon>
                        <p>No data available</p>
                        <p class="hint">Try adjusting your filter or add some data</p>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- Wrapped Row Mode -->
    <div class="wrapped-table-wrapper" *ngIf="wrappedMode">
        <div *ngIf="dataSource.filteredData.length === 0" class="no-data-message">
            <mat-icon>inbox</mat-icon>
            <p>No data available</p>
        </div>
        <div *ngFor="let row of dataSource.filteredData" class="wrapped-instance" [ngClass]="separatorClass">
            <div *ngFor="let colGroup of wrappedColumnGroups" class="wrapped-sub-row">
                <div *ngFor="let col of colGroup" class="wrapped-cell">
                    <div class="wrapped-cell-header">{{getColumnDisplayName(col)}}</div>
                    <div class="wrapped-cell-value">
                        <ng-container [ngSwitch]="getColumnType(col).toLowerCase()">
                            <string-cell *ngSwitchCase="'str'" [value]="row[col]" [columnName]="col"></string-cell>
                            <string-cell *ngSwitchCase="'string'" [value]="row[col]" [columnName]="col"></string-cell>
                            <number-cell *ngSwitchCase="'int'" [value]="row[col]" [columnName]="col" [type]="'int'"></number-cell>
                            <number-cell *ngSwitchCase="'integer'" [value]="row[col]" [columnName]="col" [type]="'int'"></number-cell>
                            <number-cell *ngSwitchCase="'float'" [value]="row[col]" [columnName]="col" [type]="'float'"></number-cell>
                            <boolean-cell *ngSwitchCase="'bool'" [value]="row[col]" [columnName]="col"></boolean-cell>
                            <boolean-cell *ngSwitchCase="'boolean'" [value]="row[col]" [columnName]="col"></boolean-cell>
                            <date-cell *ngSwitchCase="'date'" [value]="row[col]" [columnName]="col" [type]="'date'"></date-cell>
                            <date-cell *ngSwitchCase="'datetime'" [value]="row[col]" [columnName]="col" [type]="'datetime'"></date-cell>
                            <list-cell *ngSwitchCase="'list'" [value]="row[col]" [columnName]="col"></list-cell>
                            <list-cell *ngSwitchCase="'polarilist'" [value]="row[col]" [columnName]="col"></list-cell>
                            <dict-cell *ngSwitchCase="'dict'" [value]="row[col]" [columnName]="col"></dict-cell>
                            <dict-cell *ngSwitchCase="'polaridict'" [value]="row[col]" [columnName]="col"></dict-cell>
                            <object-cell *ngSwitchCase="'object'" [value]="row[col]" [columnName]="col"></object-cell>
                            <span *ngSwitchDefault>{{formatCellValue(row[col], getColumnType(col))}}</span>
                        </ng-container>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paginator -->
    <mat-paginator
        [pageSizeOptions]="[5, 10, 25, 50, 100]"
        [pageSize]="10"
        showFirstLastButtons>
    </mat-paginator>
</div>
