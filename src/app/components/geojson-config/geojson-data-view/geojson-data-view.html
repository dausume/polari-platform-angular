<div class="data-view-container">

  <!-- Pick mode top banner -->
  <div *ngIf="pickModeActive" class="pick-banner">
    <mat-icon>pin_drop</mat-icon>
    <span>Setting location for <strong>{{ pickTargetLabel }}</strong> &mdash; click on the map</span>
    <button mat-stroked-button color="warn" (click)="cancelPickMode()">
      <mat-icon>close</mat-icon> Cancel
    </button>
  </div>

  <div class="data-view-body">

    <!-- Left panel: Map -->
    <div class="map-panel">
      <map-renderer
        [config]="config"
        [instanceData]="instanceData"
        [classTypeData]="classTypeData"
        [interactive]="true"
        [pickModeActive]="pickModeActive"
        [showLocateMe]="true"
        [styleOverride]="cachedMapStyle"
        (mapClicked)="onMapClicked($event)"
        (locateMeClicked)="onLocateMeClicked()"
        (pickModeCancelled)="cancelPickMode()">
      </map-renderer>
    </div>

    <!-- Right panel: Search + Table -->
    <div class="table-panel">

      <!-- Search field -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search instances</mat-label>
        <input matInput [(ngModel)]="filterValue" (ngModelChange)="applyFilter()" placeholder="Filter...">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <!-- Data table -->
      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" matSort class="instance-table">

          <ng-container *ngFor="let col of displayedColumns" [matColumnDef]="col">
            <ng-container *ngIf="col !== '_setLocation'">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ col }}</th>
              <td mat-cell *matCellDef="let row">{{ formatCellValue(row[col]) }}</td>
            </ng-container>
            <ng-container *ngIf="col === '_setLocation'">
              <th mat-header-cell *matHeaderCellDef>Location</th>
              <td mat-cell *matCellDef="let row">
                <div class="location-actions">
                  <button mat-stroked-button color="primary" class="set-location-btn"
                          (click)="startPickMode(row)"
                          [disabled]="pickModeActive">
                    <mat-icon>{{ getSetLocationIcon(row) }}</mat-icon>
                    {{ getSetLocationLabel(row) }}
                  </button>
                  <button mat-icon-button (click)="openAddressSearchForRow(row)"
                          [disabled]="pickModeActive"
                          title="Search by address">
                    <mat-icon>search</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [class.highlighted-row]="pickTargetRow === row"></tr>

          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
              No matching instances found.
            </td>
          </tr>
        </table>
      </div>

      <mat-paginator [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons></mat-paginator>
    </div>

  </div>
</div>
