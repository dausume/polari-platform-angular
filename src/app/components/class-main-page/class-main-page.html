<mat-tab-group [selectedIndex]="selectedTabIndex" (selectedIndexChange)="onTabChange($event)">

  <!-- ===== OVERVIEW TAB ===== -->
  <mat-tab label="Overview">
    <div class="tab-content">
      <!-- Dashboard view for class pages -->
      <dashboard-renderer
          *ngIf="dashboard"
          [dashboard]="dashboard"
          [context]="dashboardContext">
      </dashboard-renderer>

      <!-- Fallback: Direct table display when no dashboard yet -->
      <div class="fallback-container" *ngIf="!dashboard && className">
          <template-class-table
              [className]="className"
              [classTypeData]="classTypeData">
          </template-class-table>
      </div>

      <!-- Loading state -->
      <div class="loading-container" *ngIf="!dashboard && !className">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading class data...</p>
      </div>
    </div>
  </mat-tab>

  <!-- ===== TABLES TAB ===== -->
  <mat-tab label="Tables">
    <div class="tab-content">

      <!-- Table Config List View (no config selected) -->
      <div *ngIf="!selectedTableConfig" class="displays-list-view">
        <div class="displays-header">
          <div>
            <h3>Table Configurations for {{ className }}</h3>
            <p class="subtitle">Create and manage custom table configurations for this class.</p>
          </div>
          <button mat-fab color="primary" (click)="openCreateTableConfigDialog()" class="create-btn">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <mat-spinner *ngIf="tableConfigsLoading" diameter="40"></mat-spinner>

        <!-- Empty state -->
        <div *ngIf="!tableConfigsLoading && tableConfigList.length === 0" class="empty-state">
          <mat-icon class="empty-icon">table_chart</mat-icon>
          <h3>No Table Configurations Yet</h3>
          <p>Get started by creating your first table configuration for this class.</p>
          <button mat-flat-button color="primary" (click)="openCreateTableConfigDialog()">
            <mat-icon>add</mat-icon> Create Your First Table Config
          </button>
        </div>

        <!-- Table config cards grid -->
        <div *ngIf="!tableConfigsLoading && tableConfigList.length > 0" class="displays-grid">
          <mat-card *ngFor="let tc of tableConfigList" class="display-card table-def-card">
            <mat-card-header>
              <mat-icon mat-card-avatar class="display-icon table-def-icon">table_chart</mat-icon>
              <mat-card-title>{{ tc.name || 'Untitled Config' }}</mat-card-title>
              <mat-card-subtitle *ngIf="tc.description">{{ tc.description }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-stroked-button color="primary" (click)="selectTableConfig(tc)" title="Edit table config">
                <mat-icon>edit</mat-icon> Edit
              </button>
              <button mat-icon-button color="warn" (click)="deleteTableConfig(tc, $event)" title="Delete table config">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <!-- Table Config Editor View (config selected) -->
      <div *ngIf="selectedTableConfig" class="display-editor-view">
        <div class="editor-toolbar">
          <div class="editor-toolbar-left">
            <button mat-icon-button (click)="deselectTableConfig()" title="Back to list">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h3>{{ selectedTableConfig.name || 'Untitled Config' }}</h3>
            <span *ngIf="hasTableDraftChanges" class="unsaved-badge">Unsaved changes</span>
          </div>
          <div class="editor-toolbar-right">
            <button mat-flat-button color="primary" *ngIf="hasTableDraftChanges" (click)="saveTableConfig()">
              <mat-icon>save</mat-icon> Save
            </button>
            <button mat-icon-button (click)="tableConfigPanelOpen = !tableConfigPanelOpen"
                    [color]="tableConfigPanelOpen ? 'primary' : ''">
              <mat-icon>settings</mat-icon>
            </button>
          </div>
        </div>

        <div class="editor-body">
          <!-- Preview area -->
          <div class="editor-preview" [class.with-config-panel]="tableConfigPanelOpen">
            <class-data-table
              [className]="className"
              [classTypeData]="classTypeData"
              [instanceData]="previewInstanceData"
              [namedTableConfig]="selectedTableConfig"
              [hideColumnSelector]="true">
            </class-data-table>
          </div>

          <!-- Config sidebar -->
          <div class="config-panel" *ngIf="tableConfigPanelOpen">
            <table-config-sidebar
              [config]="selectedTableConfig"
              [classTypeData]="classTypeData"
              (configChange)="onTableConfigChange($event)">
            </table-config-sidebar>
          </div>
        </div>
      </div>

    </div>
  </mat-tab>

  <!-- ===== GRAPHS TAB ===== -->
  <mat-tab label="Graphs">
    <div class="tab-content">

      <!-- Graph Config List View (no config selected) -->
      <div *ngIf="!selectedGraphConfig" class="displays-list-view">
        <div class="displays-header">
          <div>
            <h3>Graph Configurations for {{ className }}</h3>
            <p class="subtitle">Create and manage custom graph configurations for this class.</p>
          </div>
          <button mat-fab color="primary" (click)="openCreateGraphConfigDialog()" class="create-btn">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <mat-spinner *ngIf="graphConfigsLoading" diameter="40"></mat-spinner>

        <!-- Empty state -->
        <div *ngIf="!graphConfigsLoading && graphConfigList.length === 0" class="empty-state">
          <mat-icon class="empty-icon">show_chart</mat-icon>
          <h3>No Graph Configurations Yet</h3>
          <p>Get started by creating your first graph configuration for this class.</p>
          <button mat-flat-button color="primary" (click)="openCreateGraphConfigDialog()">
            <mat-icon>add</mat-icon> Create Your First Graph Config
          </button>
        </div>

        <!-- Graph config cards grid -->
        <div *ngIf="!graphConfigsLoading && graphConfigList.length > 0" class="displays-grid">
          <mat-card *ngFor="let gc of graphConfigList" class="display-card graph-def-card">
            <mat-card-header>
              <mat-icon mat-card-avatar class="display-icon graph-def-icon">show_chart</mat-icon>
              <mat-card-title>{{ gc.name || 'Untitled Config' }}</mat-card-title>
              <mat-card-subtitle *ngIf="gc.description">{{ gc.description }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-stroked-button color="primary" (click)="selectGraphConfig(gc)" title="Edit graph config">
                <mat-icon>edit</mat-icon> Edit
              </button>
              <button mat-icon-button color="warn" (click)="deleteGraphConfig(gc, $event)" title="Delete graph config">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <!-- Graph Config Editor View (config selected) -->
      <div *ngIf="selectedGraphConfig" class="display-editor-view">
        <div class="editor-toolbar">
          <div class="editor-toolbar-left">
            <button mat-icon-button (click)="deselectGraphConfig()" title="Back to list">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h3>{{ selectedGraphConfig.name || 'Untitled Config' }}</h3>
            <span *ngIf="hasGraphDraftChanges" class="unsaved-badge">Unsaved changes</span>
          </div>
          <div class="editor-toolbar-right">
            <button mat-flat-button color="primary" *ngIf="hasGraphDraftChanges" (click)="saveGraphConfig()">
              <mat-icon>save</mat-icon> Save
            </button>
            <button mat-icon-button (click)="graphConfigPanelOpen = !graphConfigPanelOpen"
                    [color]="graphConfigPanelOpen ? 'primary' : ''">
              <mat-icon>settings</mat-icon>
            </button>
          </div>
        </div>

        <div class="editor-body">
          <!-- Preview area -->
          <div class="editor-preview" [class.with-config-panel]="graphConfigPanelOpen">
            <graph-renderer
              [config]="selectedGraphConfig"
              [instanceData]="graphPreviewData"
              [classTypeData]="classTypeData">
            </graph-renderer>
          </div>

          <!-- Config sidebar -->
          <div class="config-panel" *ngIf="graphConfigPanelOpen">
            <graph-config-sidebar
              [config]="selectedGraphConfig"
              [classTypeData]="classTypeData"
              (configChange)="onGraphConfigChange($event)">
            </graph-config-sidebar>
          </div>
        </div>
      </div>

    </div>
  </mat-tab>

  <!-- ===== DISPLAYS TAB ===== -->
  <mat-tab label="Displays">
    <div class="tab-content">

      <!-- Display List View (no display selected) -->
      <div *ngIf="!selectedDisplay" class="displays-list-view">
        <div class="displays-header">
          <div>
            <h3>Displays for {{ className }}</h3>
            <p class="subtitle">Create and manage custom displays for this class.</p>
          </div>
          <button mat-fab color="primary" (click)="openCreateDisplayDialog()" class="create-btn">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <mat-spinner *ngIf="displaysLoading" diameter="40"></mat-spinner>

        <!-- Empty state -->
        <div *ngIf="!displaysLoading && displayList.length === 0" class="empty-state">
          <mat-icon class="empty-icon">dashboard_customize</mat-icon>
          <h3>No Displays Yet</h3>
          <p>Get started by creating your first display for this class.</p>
          <button mat-flat-button color="primary" (click)="openCreateDisplayDialog()">
            <mat-icon>add</mat-icon> Create Your First Display
          </button>
        </div>

        <!-- Display cards grid -->
        <div *ngIf="!displaysLoading && displayList.length > 0" class="displays-grid">
          <mat-card *ngFor="let display of displayList" class="display-card">
            <mat-card-header>
              <mat-icon mat-card-avatar class="display-icon">dashboard</mat-icon>
              <mat-card-title>{{ display.name || 'Untitled Display' }}</mat-card-title>
              <mat-card-subtitle *ngIf="display.description">{{ display.description }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-stroked-button color="primary" (click)="selectDisplay(display)" title="Edit display">
                <mat-icon>edit</mat-icon> Edit
              </button>
              <button mat-icon-button color="warn" (click)="deleteDisplay(display, $event)" title="Delete display">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <!-- Display Editor View (display selected) -->
      <div *ngIf="selectedDisplay" class="display-editor-view">
        <div class="editor-toolbar">
          <div class="editor-toolbar-left">
            <button mat-icon-button (click)="deselectDisplay()" title="Back to list">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h3>{{ selectedDisplay.name || 'Untitled Display' }}</h3>
            <span *ngIf="hasDraftChanges" class="unsaved-badge">Unsaved changes</span>
          </div>
          <div class="editor-toolbar-right">
            <button mat-icon-button (click)="toggleDisplayGridlines()" title="Toggle gridlines"
                    [color]="displayShowGridlines ? 'primary' : ''">
              <mat-icon>grid_on</mat-icon>
            </button>
            <button mat-icon-button (click)="toggleDisplayEditMode()" title="Toggle edit mode"
                    [color]="displayEditMode ? 'accent' : ''">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-flat-button color="primary" *ngIf="hasDraftChanges" (click)="saveDisplay()">
              <mat-icon>save</mat-icon> Save
            </button>
            <button mat-icon-button (click)="configPanelOpen = !configPanelOpen"
                    [color]="configPanelOpen ? 'primary' : ''">
              <mat-icon>settings</mat-icon>
            </button>
          </div>
        </div>

        <div class="editor-body">
          <!-- Preview area -->
          <div class="editor-preview" [class.with-config-panel]="configPanelOpen">
            <dashboard-renderer
              [dashboard]="selectedDisplay"
              [context]="dashboardContext"
              [editMode]="displayEditMode"
              [showGridlines]="displayShowGridlines || displayEditMode"
              (cellSelected)="onDisplayCellSelected($event)"
              (itemRemoved)="onDisplayItemRemoved($event)"
              (containerWidthMeasured)="onRendererWidthMeasured($event)">
            </dashboard-renderer>
          </div>

          <!-- Config panel -->
          <div class="config-panel" *ngIf="configPanelOpen">
            <div class="config-panel-content">

              <!-- Display Properties -->
              <div class="config-section">
                <h4>Display Properties</h4>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Name</mat-label>
                  <input matInput [(ngModel)]="selectedDisplay.name" (ngModelChange)="onDisplayPropertyChange()">
                </mat-form-field>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Description</mat-label>
                  <textarea matInput [(ngModel)]="selectedDisplay.description" (ngModelChange)="onDisplayPropertyChange()" rows="2"></textarea>
                </mat-form-field>
              </div>

              <mat-divider></mat-divider>

              <!-- Rows (recursive config template) -->
              <ng-template #rowConfigTemplate
                           let-rows="rows" let-parentItem="parentItem"
                           let-depth="depth" let-availableWidth="availableWidth">
                <mat-accordion>
                  <mat-expansion-panel *ngFor="let row of rows; let i = index">
                    <mat-expansion-panel-header>
                      <mat-panel-title>Row {{ i + 1 }}</mat-panel-title>
                      <mat-panel-description>
                        {{ row.rowSegments }} cols, {{ row.dashboardItems.length }} items
                      </mat-panel-description>
                    </mat-expansion-panel-header>

                    <div class="row-config">
                      <mat-form-field appearance="outline" class="half-width">
                        <mat-label>Segments</mat-label>
                        <input matInput type="number" [(ngModel)]="row.rowSegments"
                               (ngModelChange)="onDisplayPropertyChange()" min="1"
                               [max]="availableWidth ? calculateMaxColumnsForConfig(availableWidth) : 24">
                        <mat-hint *ngIf="availableWidth">Max {{ calculateMaxColumnsForConfig(availableWidth) }} cols</mat-hint>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="half-width">
                        <mat-label>Min Height (px)</mat-label>
                        <input matInput type="number" [(ngModel)]="row.minRowHeight" (ngModelChange)="onDisplayPropertyChange()" min="0">
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="half-width">
                        <mat-label>Max Height (px)</mat-label>
                        <input matInput type="number" [(ngModel)]="row.maxRowHeight" (ngModelChange)="onDisplayPropertyChange()">
                      </mat-form-field>

                      <mat-slide-toggle [(ngModel)]="row.autoHeight" (ngModelChange)="onDisplayPropertyChange()">
                        Auto Height
                      </mat-slide-toggle>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>CSS Class</mat-label>
                        <input matInput [(ngModel)]="row.cssClass" (ngModelChange)="onDisplayPropertyChange()">
                      </mat-form-field>

                      <!-- Items list with nested container expansion -->
                      <div class="row-items-summary" *ngIf="row.dashboardItems.length > 0">
                        <h5>Items ({{ row.dashboardItems.length }})</h5>
                        <div *ngFor="let item of row.dashboardItems" class="config-item-entry">
                          <div class="config-item-header">
                            <mat-icon>{{ getItemIcon(item.type) }}</mat-icon>
                            <span>{{ item.title || item.type }} ({{ item.rowSegmentsUsed }} cols)</span>
                          </div>
                          <!-- Nested rows for container items -->
                          <div *ngIf="item.type === 'container' && item.nestedRows"
                               class="nested-row-config depth-{{ depth + 1 }}"
                               [ngClass]="'depth-' + (depth + 1)">
                            <div class="nested-config-header">
                              <h5><mat-icon style="font-size:14px;width:14px;height:14px">view_agenda</mat-icon> Nested Rows</h5>
                              <button mat-icon-button color="primary"
                                      (click)="addNestedRow(item, availableWidth, row.rowSegments)"
                                      title="Add nested row">
                                <mat-icon>add</mat-icon>
                              </button>
                            </div>
                            <div *ngIf="item.nestedRows.length === 0" style="font-size:12px;color:#999;padding:4px 0">
                              No nested rows. Click + to add one.
                            </div>
                            <ng-container *ngTemplateOutlet="rowConfigTemplate; context: {
                              rows: item.nestedRows,
                              parentItem: item,
                              depth: depth + 1,
                              availableWidth: calculateNestedWidthForConfig(availableWidth, item.rowSegmentsUsed, row.rowSegments)
                            }"></ng-container>
                          </div>
                        </div>
                      </div>

                      <button mat-stroked-button color="warn"
                              (click)="parentItem ? removeNestedRow(parentItem, i) : removeDisplayRow(i)">
                        <mat-icon>delete</mat-icon> Remove Row
                      </button>
                    </div>
                  </mat-expansion-panel>
                </mat-accordion>
              </ng-template>

              <div class="config-section">
                <div class="section-header">
                  <h4>Rows</h4>
                  <button mat-icon-button color="primary" (click)="addDisplayRow()" title="Add Row">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>

                <div *ngIf="selectedDisplay.rows.length === 0" class="empty-rows">
                  <p>No rows yet. Add a row to start building your display.</p>
                </div>

                <ng-container *ngTemplateOutlet="rowConfigTemplate; context: {
                  rows: selectedDisplay.rows,
                  parentItem: null,
                  depth: 0,
                  availableWidth: rendererContainerWidth
                }"></ng-container>

                <button mat-stroked-button color="primary" (click)="addDisplayRow()" class="add-row-btn">
                  <mat-icon>add</mat-icon> Add Row
                </button>
              </div>

              <mat-divider></mat-divider>

              <!-- Component Palette (visible in edit mode) -->
              <div class="config-section" *ngIf="displayEditMode">
                <h4>Components</h4>
                <p class="palette-hint">Select a grid cell, then click a component to place it.</p>

                <!-- Tables -->
                <div class="palette-group" *ngIf="tableConfigList.length > 0">
                  <h5 class="palette-group-title">
                    <mat-icon class="palette-group-icon table-icon">table_chart</mat-icon>
                    Tables
                  </h5>
                  <div class="palette-items">
                    <div class="palette-item" *ngFor="let tc of tableConfigList"
                         (click)="placeComponentInCell('table', tc.id, tc.name)">
                      <mat-icon class="table-icon">table_chart</mat-icon>
                      <span class="palette-item-name">{{ tc.name || 'Untitled' }}</span>
                      <mat-icon class="palette-add-icon">add_circle_outline</mat-icon>
                    </div>
                  </div>
                </div>

                <!-- Graphs -->
                <div class="palette-group" *ngIf="graphConfigList.length > 0">
                  <h5 class="palette-group-title">
                    <mat-icon class="palette-group-icon graph-icon">show_chart</mat-icon>
                    Graphs
                  </h5>
                  <div class="palette-items">
                    <div class="palette-item" *ngFor="let gc of graphConfigList"
                         (click)="placeComponentInCell('graph', gc.id, gc.name)">
                      <mat-icon class="graph-icon">show_chart</mat-icon>
                      <span class="palette-item-name">{{ gc.name || 'Untitled' }}</span>
                      <mat-icon class="palette-add-icon">add_circle_outline</mat-icon>
                    </div>
                  </div>
                </div>

                <!-- Built-in -->
                <div class="palette-group">
                  <h5 class="palette-group-title">
                    <mat-icon class="palette-group-icon">widgets</mat-icon>
                    Built-in
                  </h5>
                  <div class="palette-items">
                    <div class="palette-item" (click)="placeComponentInCell('text')">
                      <mat-icon>text_fields</mat-icon>
                      <span class="palette-item-name">Text Block</span>
                      <mat-icon class="palette-add-icon">add_circle_outline</mat-icon>
                    </div>
                    <div class="palette-item" (click)="placeComponentInCell('metric')">
                      <mat-icon>analytics</mat-icon>
                      <span class="palette-item-name">Metric Card</span>
                      <mat-icon class="palette-add-icon">add_circle_outline</mat-icon>
                    </div>
                    <div class="palette-item" (click)="placeComponentInCell('container')">
                      <mat-icon>view_agenda</mat-icon>
                      <span class="palette-item-name">Row Container</span>
                      <mat-icon class="palette-add-icon">add_circle_outline</mat-icon>
                    </div>
                  </div>
                </div>

                <!-- Empty state for configs -->
                <div *ngIf="tableConfigList.length === 0 && graphConfigList.length === 0" class="palette-empty">
                  <p>No saved table or graph configs found for this class. Create them in the Tables or Graphs tabs.</p>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    </div>
  </mat-tab>

  <!-- ===== CONFIGURATION TAB ===== -->
  <mat-tab label="Configuration">
    <div class="tab-content">
      <div class="config-tab-view">
        <h3>Class Configuration</h3>
        <p class="subtitle">Manage class-level feature toggles for {{ className }}.</p>

        <!-- State-Space Toggle Section -->
        <div class="config-toggle-section">
          <h4>State-Space</h4>
          <div class="config-toggle-row">
            <mat-slide-toggle
              [checked]="classPolyTypingObj?.config?.isStateSpaceObject || false"
              [disabled]="stateSpaceUpdating"
              (change)="onStateSpaceToggle($event.checked)">
              State-Space Object
            </mat-slide-toggle>
            <mat-spinner *ngIf="stateSpaceUpdating" diameter="18" class="inline-spinner"></mat-spinner>
          </div>
          <span class="flag-hint">Enable to make this class available in No-Code State-Space environments.</span>
        </div>

        <!-- GeoJSON Toggle Section -->
        <div class="config-toggle-section">
          <h4>GeoJSON Map</h4>
          <div class="config-toggle-row">
            <mat-slide-toggle
              [checked]="isGeoJsonEnabled"
              [disabled]="geoJsonAutoCreating"
              (change)="onGeoJsonToggle($event.checked)">
              GeoJSON Enabled
            </mat-slide-toggle>
            <mat-spinner *ngIf="geoJsonAutoCreating" diameter="18" class="inline-spinner"></mat-spinner>
          </div>
          <span class="flag-hint">Enable to auto-create a default GeoJSON map configuration for this class.</span>

          <!-- GeoJSON status bar when enabled -->
          <div *ngIf="isGeoJsonEnabled" class="geojson-status-inline">
            <div class="geojson-status-info">
              <mat-icon class="geojson-status-icon">map</mat-icon>
              <span>{{ geoJsonConfigList.length }} GeoJSON configuration(s) active</span>
            </div>
            <button mat-stroked-button color="primary" (click)="navigateToGeoJsonTab()">
              <mat-icon>settings</mat-icon> Manage
            </button>
          </div>
        </div>

        <!-- Edit Class Definition Section -->
        <div class="config-toggle-section" *ngIf="classPolyTypingObj?.canEditClassDefinition()">
          <h4>Class Definition</h4>
          <div class="config-toggle-row">
            <button mat-raised-button color="primary"
              [disabled]="editClassLoading"
              (click)="openEditClassDialog()">
              <mat-icon>edit</mat-icon> Edit Class Definition
            </button>
            <mat-spinner *ngIf="editClassLoading" diameter="18" class="inline-spinner"></mat-spinner>
          </div>
          <span class="flag-hint">Modify the variable definitions for this dynamically created class.</span>
        </div>

      </div>
    </div>
  </mat-tab>

  <!-- ===== GEOJSON TAB ===== -->
  <mat-tab label="GeoJSON">
    <div class="tab-content">

      <!-- GeoJSON Config List View (no config selected) -->
      <div *ngIf="!selectedGeoJsonConfig" class="displays-list-view">
        <div class="displays-header">
          <div>
            <h3>GeoJSON Map Configurations for {{ className }}</h3>
            <p class="subtitle">Create and manage GeoJSON map configurations for this class.</p>
          </div>
          <button mat-fab color="primary" (click)="openCreateGeoJsonConfigDialog()" class="create-btn">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <mat-spinner *ngIf="geoJsonConfigsLoading" diameter="40"></mat-spinner>

        <!-- Empty state -->
        <div *ngIf="!geoJsonConfigsLoading && geoJsonConfigList.length === 0" class="empty-state">
          <mat-icon class="empty-icon geojson-def-icon">map</mat-icon>
          <h3>No GeoJSON Configurations Yet</h3>
          <p>Get started by creating your first GeoJSON map configuration for this class.</p>
          <button mat-flat-button color="primary" (click)="openCreateGeoJsonConfigDialog()">
            <mat-icon>add</mat-icon> Create Your First GeoJSON Config
          </button>
        </div>

        <!-- GeoJSON config cards grid -->
        <div *ngIf="!geoJsonConfigsLoading && geoJsonConfigList.length > 0" class="displays-grid">
          <mat-card *ngFor="let gjc of geoJsonConfigList" class="display-card geojson-def-card">
            <mat-card-header>
              <mat-icon mat-card-avatar class="display-icon geojson-def-icon">map</mat-icon>
              <mat-card-title>{{ gjc.name || 'Untitled Config' }}</mat-card-title>
              <mat-card-subtitle *ngIf="gjc.description">{{ gjc.description }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-stroked-button color="primary" (click)="selectGeoJsonConfig(gjc)" title="Edit GeoJSON config">
                <mat-icon>edit</mat-icon> Edit
              </button>
              <button mat-icon-button color="warn" (click)="deleteGeoJsonConfig(gjc, $event)" title="Delete GeoJSON config">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <!-- GeoJSON Config Editor View (config selected) -->
      <div *ngIf="selectedGeoJsonConfig" class="display-editor-view">
        <div class="editor-toolbar">
          <div class="editor-toolbar-left">
            <button mat-icon-button (click)="deselectGeoJsonConfig()" title="Back to list">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h3>{{ selectedGeoJsonConfig.name || 'Untitled Config' }}</h3>
            <span *ngIf="hasGeoJsonDraftChanges" class="unsaved-badge">Unsaved changes</span>
          </div>
          <div class="editor-toolbar-right">
            <mat-button-toggle-group [value]="geoJsonViewMode"
                                     (change)="onGeoJsonViewModeChange($event.value)"
                                     class="view-mode-toggle">
              <mat-button-toggle value="config" title="Configuration editor">
                <mat-icon>settings</mat-icon>
              </mat-button-toggle>
              <mat-button-toggle value="data" title="Interactive data view">
                <mat-icon>place</mat-icon>
              </mat-button-toggle>
            </mat-button-toggle-group>
            <button mat-flat-button color="primary" *ngIf="hasGeoJsonDraftChanges && geoJsonViewMode === 'config'" (click)="saveGeoJsonConfig()">
              <mat-icon>save</mat-icon> Save
            </button>
            <button mat-icon-button *ngIf="geoJsonViewMode === 'config'"
                    (click)="geoJsonConfigPanelOpen = !geoJsonConfigPanelOpen"
                    [color]="geoJsonConfigPanelOpen ? 'primary' : ''">
              <mat-icon>settings</mat-icon>
            </button>
          </div>
        </div>

        <!-- Config Editor View -->
        <div class="editor-body" *ngIf="geoJsonViewMode === 'config'">
          <!-- Preview area -->
          <div class="editor-preview" [class.with-config-panel]="geoJsonConfigPanelOpen">
            <map-renderer
              [config]="selectedGeoJsonConfig"
              [instanceData]="geoJsonPreviewData"
              [classTypeData]="classTypeData">
            </map-renderer>
          </div>

          <!-- Config sidebar -->
          <div class="config-panel" *ngIf="geoJsonConfigPanelOpen">
            <geojson-config-sidebar
              [config]="selectedGeoJsonConfig"
              [classTypeData]="classTypeData"
              (configChange)="onGeoJsonConfigChange($event)">
            </geojson-config-sidebar>
          </div>
        </div>

        <!-- Interactive Data View -->
        <div class="editor-body" *ngIf="geoJsonViewMode === 'data'">
          <geojson-data-view
            [config]="selectedGeoJsonConfig"
            [instanceData]="geoJsonPreviewData"
            [classTypeData]="classTypeData"
            [className]="className!"
            (instanceDataChange)="onGeoJsonInstanceDataChange($event)">
          </geojson-data-view>
        </div>
      </div>

    </div>
  </mat-tab>

</mat-tab-group>
